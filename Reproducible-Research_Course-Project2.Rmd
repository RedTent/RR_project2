---
title: "Descriptive title"
author: "Johan van Tent"
date: "2019-10-30"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, echo = TRUE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
suppressPackageStartupMessages(library(tidyverse))

# Questions
# 
# Your data analysis must address the following questions:
# 
# 1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most
#    harmful with respect to population health?
# 2. Across the United States, which types of events have the greatest economic consequences?

```

## Synopsis

**synopsis** - 10 sentences max

## Data Processing

### Downloading and reading

This project involves exploring the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. This database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

This Storm Dataset can be downloaded using this [link](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2).

```{r downloading-data}

# download data if necessary - but only once

if (!dir.exists("data")) dir.create("data")

if (!file.exists("data/storm_data.bz2")) { 
  download.file(url = "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2",
                destfile = "data/storm_data.bz2")
}
```

The Storm Dataset comes as compressed csv-file. It can be read into a dataframe using the `read_csv()`-function.

```{r reading-data, cache=TRUE}

# readr::read_csv can read zipped files directly

storm_data <- read_csv("data/storm_data.bz2",
                col_types = cols(BGN_DATE = col_date("%m/%d/%Y %H:%M:%S"),
                                 PROPDMGEXP = col_character(),
                                 CROPDMGEXP = col_character()))
# # temporary
 # storm_data <- read_csv("data/storm_data",
 #                  col_types = cols(BGN_DATE = col_date("%m/%d/%Y %H:%M:%S"))) 

```

### Inspecting the data

```{r inspecting-data}

n_rows <- nrow(storm_data)
n_vars <- ncol(storm_data)

n_event_types <- length(unique(storm_data$EVTYPE))

```

The storm dataset has:

- `r n_vars` variables
- `r n_rows` rows 
- `r n_event_types` unique event labels

The first events were recorded in 1950. In general more events are recorded in recent years. This is shown in the graph below.

```{r event-count, fig.cap="*Number of recorded events in the storm dataset*", fig.width = 8}
  storm_data %>% 
  mutate(year = lubridate::year(BGN_DATE)) %>% 
  ggplot(aes(year)) + 
  geom_bar() + 
  labs(title = "Number of events per year")
```



### Transformations

In the variable `EVTYPE` there seem to be a number of different labels that refer to the same type of event, e.g. *THUNDERSTORM WIND* and *THUNDERSTORM WINDS*. It is therefore necessary to clean the labels of the events. For this analysis we're only interested in events that cause a lot of injuries or damage. Therefore we'll only relabel those events that occur often or cause a lot of damage or injuries.

We're interested in preventing damage and casualties for future events. It seems reasonable to think that only recent events are relevant for this purpose. Therefore we choose to only include data from 2000 or later in the analysis. Apart from that, it seems also likely that a lot of events are missing in earlier years.

Damage is expressed in thousands (K), millions (M) or billions (B). To be able to compare the amount of damage it is necessary to convert the damage to the same unit.

```{r transformations}

relabel_df <- tibble::tribble(
               ~EVTYPE,         ~EVTYPE_NEW,
  "THUNDERSTORM WINDS", "THUNDERSTORM WIND",
           "TSTM WIND", "THUNDERSTORM WIND",
      "EXCESSIVE HEAT",              "HEAT"
  )

storm_data_trans <- 
  storm_data %>% 
  left_join(relabel_df, by = "EVTYPE") %>% 
  mutate(EVTYPE = ifelse(is.na(EVTYPE_NEW), EVTYPE, EVTYPE_NEW)) %>% 
  
  filter(lubridate::year(BGN_DATE) >= 2000) %>% 
  
  mutate(CROPDMG = case_when(
    CROPDMGEXP == "K" ~ CROPDMG * 1000,
    CROPDMGEXP == "M" ~ CROPDMG * 1000 * 1000,
    CROPDMGEXP == "B" ~ CROPDMG * 1000 * 1000 * 1000,
    TRUE ~ CROPDMG),
         PROPDMG = case_when(
    PROPDMGEXP == "K" ~ PROPDMG * 1000,
    PROPDMGEXP == "M" ~ PROPDMG * 1000 * 1000,
    PROPDMGEXP == "B" ~ PROPDMG * 1000 * 1000 * 1000,
    TRUE ~ PROPDMG)
    )

```


## Results

### Harmful events

```{r harmful-events, fig.width = 10, fig.cap="*The 10 most harmful events since 2000*"}
# Selecting only events with harmful effects for people: At least 1 fatality or 1 injury. 
harmful_events <- storm_data_trans %>% 
  filter(FATALITIES > 0 | INJURIES > 0)


# Determining and plotting the most harmful events
harmful_events %>% 
  group_by(EVTYPE) %>% 
  summarise(Fatalities = sum(FATALITIES, na.rm = TRUE), 
            Injuries = sum(INJURIES, na.rm = TRUE)) %>% 
  ungroup() %>% 
  arrange(desc(Fatalities)) %>% 
  top_n(10, wt = Fatalities) %>% 
  gather("harm_type", "n", -EVTYPE) %>% 
  ggplot(aes(fct_rev(fct_inorder(EVTYPE)), n)) + 
  geom_col() + 
  facet_wrap(~harm_type, scales = "free") +
  labs(title = "Most harmful event-types since 2000",
       x = "",
       y = "Number of casualties") +
  coord_flip()


```

### Economic damage

```{r damaging-events, fig.width = 8, fig.cap="*The 10 most damaging types of events*"}

damaging_events <- storm_data_trans %>% 
  filter(PROPDMG > 0 | CROPDMG > 0) %>% 
  mutate(DAMAGE = PROPDMG + CROPDMG)

damaging_events %>% 
  group_by(EVTYPE) %>% 
  summarise(DAMAGE = sum(DAMAGE, na.rm = TRUE)) %>% 
  ungroup() %>% 
  arrange(desc(DAMAGE)) %>% 
  top_n(10, wt = DAMAGE) %>% 
  ggplot(aes(fct_rev(fct_inorder(EVTYPE)), DAMAGE / 1000000000)) + 
  geom_col() + 
  labs(title = "Most damaging event-types since 2000",
       x = "",
       y = "Billions of Dollars") +
  coord_flip()


```


